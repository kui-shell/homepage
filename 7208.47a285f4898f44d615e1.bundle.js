(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[7208,2383],{36065:(e,n,i)=>{"use strict";i.r(n),i.d(n,{getChannelForTab:()=>d,getSessionForTab:()=>f,init:()=>p,invalidateSession:()=>y,pollUntilOnline:()=>h});var s=i(11227),t=i.n(s),o=i(51173),r=i(95233);const l=t()("plugins/bash-like/pty/ui");var c=function(e,n,i,s){return new(i||(i=Promise))((function(t,o){function r(e){try{c(s.next(e))}catch(e){o(e)}}function l(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,l)}c((s=s.apply(e,n||[])).next())}))};const u=(0,o.i18n)("plugin-bash-like"),a=t()("plugins/bash-like/pty/session");function d(e){return e.ws}function f(e){return c(this,void 0,void 0,(function*(){if(void 0===e._kui_session&&(0,o.inElectron)()){const n=new r.IJ;return yield n.init(),e._kui_session=Promise.resolve(n),e._kui_session}return e._kui_session}))}function h(e){return new Promise((n=>{let i=!1;const s=setTimeout((()=>{i||(l("setOffline"),o.eventChannelUnsafe.emit("/proxy/offline"))}),5e3),t=(r=0)=>(a("trying to establish session",e),e.REPL.qexec("echo initializing session",void 0,void 0,{tab:e}).then((()=>{i=!0,clearTimeout(s),l("setOnline"),o.eventChannelUnsafe.emit("/proxy/online"),n()})).catch((e=>{const n=e;return 503!==n.code&&console.error("error establishing session",n.code,n.statusCode,n),setTimeout((()=>t(r+1)),r<10?2e3:r<100?4e3:1e4),u("Could not establish a new session")})));t()}))}let v;function b(e){return c(this,void 0,void 0,(function*(){const n=v||new Promise(((n,i)=>c(this,void 0,void 0,(function*(){try{yield h(e),e.classList.add("kui--session-init-done"),n(d(e))}catch(e){i(e)}}))));v||(v=n),e._kui_session=n,yield n,e.classList.add("kui--session-init-done")}))}function y(e){v=void 0,o.eventBus.emit("/tab/offline",e),o.eventBus.emitWithTabId("/tab/offline",e.state.uuid)}function p(e){return c(this,void 0,void 0,(function*(){const{proxyServer:n}=yield i.e(9599).then(i.t.bind(i,69599,19)).catch((()=>(console.log("using default proxy configuration"),{proxyServer:{enabled:!1}})));if((0,o.inBrowser)()&&!1!==n.enabled){a("initializing pty sessions");const{eventBus:n}=yield Promise.resolve().then(i.bind(i,51173));e.registerSessionInitializer(b),n.on("/tab/close",(e=>c(this,void 0,void 0,(function*(){try{a("closing session for tab");const n=d(e);n&&n.close()}catch(e){console.error("error terminating session for closed tab",e)}}))))}}))}},32383:()=>{}}]);