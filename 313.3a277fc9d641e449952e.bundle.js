(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[313,2383,7208],{31563:(e,n,t)=>{"use strict";t.d(n,{E6:()=>o.getSessionForTab,fF:()=>s.XN,Io:()=>s.Io});t(82208),t(53462);var o=t(36065),s=t(68993)},68993:(e,n,t)=>{"use strict";t.d(n,{XN:()=>a,Io:()=>d,MA:()=>u});var o=t(11227),s=t.n(o),i=t(51173),r=function(e,n,t,o){return new(t||(t=Promise))((function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(r,c)}a((o=o.apply(e,n||[])).next())}))};const c=s()("plugins/bash-like/cmds/catchall"),a=({tab:e,command:n,argvNoOptions:o,execOptions:s,parsedOptions:c,createOutputStream:a})=>r(void 0,void 0,void 0,(function*(){const r=e=>{throw e.message&&"string"==typeof e.message?new Error(e.message.replace(/[a-zA-Z0-9/]+:\s*/,"").trim()):e},d=(s.raw||s.type===i.ExecType.Nested)&&void 0===s.quiet&&void 0===s.echo&&void 0===s.replSilence,u=d||s.isProxied?s:Object.assign({},{stdout:yield a()},s),l=n.replace(/^(!|sendtopty)\s+/,"");if((0,i.isHeadless)()||!(0,i.inBrowser)()&&d){const{doExec:e}=yield t.e(5438).then(t.bind(t,5438)),n=yield e(l,u).catch(r);if(d&&("number"==typeof n||"boolean"==typeof n))return n;if(d&&"string"==typeof n)try{return isNaN(parseInt(n))?JSON.parse(n):n}catch(e){}return n}{const{doExec:n}=yield Promise.all([t.e(8575),t.e(9267),t.e(2320),t.e(5301),t.e(1051)]).then(t.bind(t,51153)),s=()=>n(e,l,o,c,u);if(d){u.quiet=!0,u.echo=!1,u.replSilence=!0;let e="";return u.onInit=()=>n=>{"string"==typeof n&&(e+=n)},s().then((()=>e)).catch(r)}return s().catch(r)}}));function d(e){return r(this,void 0,void 0,(function*(){return new Promise(((n,t)=>r(this,void 0,void 0,(function*(){let o="";const s=Object.assign({},e.execOptions,{rethrowErrors:!0,quiet:!0,replSilence:!0,echo:!1,onInit:()=>e=>{"string"==typeof e&&(o+=e)}}),i=Object.assign({},e,{execOptions:s});yield a(i).catch((e=>{console.error(e),e.message=o||e.message,t(e)})),n(o)}))))}))}const u=e=>{if(!(0,i.inBrowser)()||(0,i.hasProxy)())return e.catchall((()=>!0),a,0);c("skipping catchall registration: in browser and no remote proxy to support it")}},36065:(e,n,t)=>{"use strict";t.r(n),t.d(n,{getChannelForTab:()=>l,getSessionForTab:()=>p,init:()=>v,invalidateSession:()=>g,pollUntilOnline:()=>y});var o=t(11227),s=t.n(o),i=t(51173),r=t(95233);const c=s()("plugins/bash-like/pty/ui");var a=function(e,n,t,o){return new(t||(t=Promise))((function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(r,c)}a((o=o.apply(e,n||[])).next())}))};const d=(0,i.i18n)("plugin-bash-like"),u=s()("plugins/bash-like/pty/session");function l(e){return e.ws}function p(e){return a(this,void 0,void 0,(function*(){if(void 0===e._kui_session&&(0,i.inElectron)()){const n=new r.IJ;return yield n.init(),e._kui_session=Promise.resolve(n),e._kui_session}return e._kui_session}))}function y(e){return new Promise((n=>{let t=!1;const o=setTimeout((()=>{t||(c("setOffline"),i.eventChannelUnsafe.emit("/proxy/offline"))}),5e3),s=(r=0)=>(u("trying to establish session",e),e.REPL.qexec("echo initializing session",void 0,void 0,{tab:e}).then((()=>{t=!0,clearTimeout(o),c("setOnline"),i.eventChannelUnsafe.emit("/proxy/online"),n()})).catch((e=>{const n=e;return 503!==n.code&&console.error("error establishing session",n.code,n.statusCode,n),setTimeout((()=>s(r+1)),r<10?2e3:r<100?4e3:1e4),d("Could not establish a new session")})));s()}))}let f;function h(e){return a(this,void 0,void 0,(function*(){const n=f||new Promise(((n,t)=>a(this,void 0,void 0,(function*(){try{yield y(e),e.classList.add("kui--session-init-done"),n(l(e))}catch(e){t(e)}}))));f||(f=n),e._kui_session=n,yield n,e.classList.add("kui--session-init-done")}))}function g(e){f=void 0,i.eventBus.emit("/tab/offline",e),i.eventBus.emitWithTabId("/tab/offline",e.state.uuid)}function v(e){return a(this,void 0,void 0,(function*(){const{proxyServer:n}=yield t.e(9599).then(t.t.bind(t,69599,19)).catch((()=>(console.log("using default proxy configuration"),{proxyServer:{enabled:!1}})));if((0,i.inBrowser)()&&!1!==n.enabled){u("initializing pty sessions");const{eventBus:n}=yield Promise.resolve().then(t.bind(t,51173));e.registerSessionInitializer(h),n.on("/tab/close",(e=>a(this,void 0,void 0,(function*(){try{u("closing session for tab");const n=l(e);n&&n.close()}catch(e){console.error("error terminating session for closed tab",e)}}))))}}))}},17906:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>f});var o=t(11227),s=t.n(o),i=t(72045),r=t(51173),c=t(88126),a=t(31563),d=t(7716),u=function(e,n,t,o){return new(t||(t=Promise))((function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(r,c)}a((o=o.apply(e,n||[])).next())}))};const l=s()("plugins/proxy-support/executor"),p=new r.DirectReplEval;function y(e){const n=document.createElement(e.nodeType||"span");return e.className.length>0?n.className=e.className:e.classList.classList.length>0&&e.classList.classList.forEach((e=>{n.classList.add(e)})),e.innerText?n.innerText=e.innerText:e.children&&e.children.length>0&&e.children.forEach((e=>{n.appendChild(y(e))})),n}const f=class{constructor(){this.name="ProxyEvaluator",this.proxyServerConfig=(0,c.vc)().then((e=>e.proxyServer))}apply(e,n,t,o){return u(this,void 0,void 0,(function*(){l("apply",t),l("execOptions",n);const s=yield this.proxyServerConfig;if((0,c.pK)(s)||(0,r.isCommandHandlerWithEvents)(t)&&t.options&&!t.options.requiresLocal)return l("delegating to direct evaluator"),p.apply(e,n,t,o);{const t=(0,r.withLanguage)(Object.assign({},n,{block:void 0,nextBlock:void 0,isProxied:!0,cwd:d.env.PWD,env:d.env&&n.env?Object.assign(Object.assign({},d.env),n.env):n.env?n.env:d.env,credentials:(0,r.getValidCredentials)(),tab:void 0,rawResponse:!0}));if("bash websocket open"!==e)return new Promise(((s,c)=>u(this,void 0,void 0,(function*(){const u=(0,i.Z)();l("delegating to proxy websocket",e,u);const p=yield(0,a.E6)(o.tab),f=void 0!==n.onInit,h={type:"request",cmdline:e,uuid:u,stream:f,cwd:d.env.PWD,execOptions:t},g=n.onInit?yield n.onInit({write:e=>p.send(JSON.stringify({type:"data",data:e,uuid:u})),xon:()=>{l("xon requested on streaming proxy exec"),p.send(JSON.stringify({type:"xon",uuid:u}))},xoff:()=>{l("xoff requested on streaming proxy exec"),p.send(JSON.stringify({type:"xoff",uuid:u}))},abort:()=>{l("abort requested on streaming proxy exec"),p.send(JSON.stringify({type:"kill",uuid:u}))}}):void 0;p.send(JSON.stringify(h));let v="";const m=e=>{const{data:t}=e;if(v+=t,t.endsWith("\n"))try{const e=v;v="",e.split("\n").filter((e=>e)).forEach((e=>{const t=JSON.parse(e);if(t.uuid===u){if("chunk"===t.type)return void g(t.chunk);p.removeEventListener("message",m);const e=t.response.code||t.response.statusCode;if(n.onExit&&n.onExit(e),void 0!==e&&200!==e)if((0,r.isUsageError)(t.response))l("rejecting as usage error",t),c(t.response);else{l("rejecting as other error",t);const n=new Error(t.response.message);n.stack=t.response.stack,n.code=e,n.statusCode=void 0!==t.response.statusCode?t.response.statusCode:e,n.body=t.response,c(n)}else if(r.ElementMimic.isFakeDom(t.response))l("rendering fakedom",t.response),s(y(t.response));else if(r.ElementMimic.isFakeDom(t.response.content))l("rendering fakedom content",t.response.content),t.response.content=y(t.response.content),s(t.response);else if(t.response.message&&t.response.stack){const e=new Error(t.response.message);e.stack=t.response.stack,c(e)}else l("response",t),s(t.response)}}))}catch(e){console.error("error handling response",v),console.error(e),c(new Error("Internal Error"))}};p.on("message",m)}))));l("delegating to proxy exec",e);const c={command:e,execOptions:t};l("sending body",c);try{const e=/KUI_PROXY_COHOSTED=true/.test(document.cookie)?`${window.location.pathname.replace(/index\.html/,"")}exec`:new URL(s.url,window.location.origin).href;l("proxy server url",e);const n=()=>new Promise((n=>{const t=new XMLHttpRequest;t.open("POST",e),t.responseType="json",t.withCredentials=!0,t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("Accept","application/json"),t.addEventListener("error",(()=>{4===t.readyState&&0===t.status?n({statusCode:503,code:503,body:"Connection refused"}):(console.error("error in xhr",t.status,t),n(t.response||"Internal Error"))})),t.addEventListener("load",(()=>{n({statusCode:t.status,body:t.response.response})})),t.send(JSON.stringify(c))})),t=yield window["webview-proxy"]?window["webview-proxy"](c):n();if(200!==t.statusCode){l("rethrowing non-200 response",t);const e=new Error(t.body);throw e.code=e.statusCode=t.statusCode,e.body=t.body,e}if(r.ElementMimic.isFakeDom(t.body)){if(l("catch a fakedom, try to unwind"),t.body.innerText)return t.body.innerText;{const e=new Error("Internal Error: Fakedom objects are not accepted by proxy executor");throw e.code=500,e}}return t.body}catch(e){if(l("proxy execution resulted in an error, recasting to local exception",e.code,e.message,e.body,e),e.body&&(0,r.isUsageError)(e.body))throw l("the error is a usage error, rethrowing as such"),new r.UsageError({message:e.body.raw.message,usage:e.body.raw.usage,code:e.body.code,extra:e.body.extra});{const n=new Error(e.body&&e.body.message||("string"==typeof e.body?e.body:e.message||"Internal error"));throw n.code=n.statusCode=e.body&&e.body.code||e.code||e.statusCode,l("using this code",n.code),n}}}}))}}},32383:()=>{}}]);