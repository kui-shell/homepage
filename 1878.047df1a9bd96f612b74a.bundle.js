(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[1878],{51878:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>_});var o=n(19945),a=n(51173),r=n(67294);function i(e,t){return r.createElement("span",null,e,r.createElement("span",{className:"even-lighter-text"},"／"),t)}function c(e){return function(e){return"number"==typeof e.fraction}(e)?100*e.fraction+"%":e.fractionString}function u(e){const t={backgroundColor:e.color,bodrerRight:"1px solid var(--color-stripe-02)",width:c(e)};return r.createElement("div",{style:{display:"flex",backgroundColor:"var(--color-stripe-01)",height:"1em",width:"5em"}},r.createElement("div",{style:t}))}function s(e){const t={display:"flex",flexDirection:e.flexDirection||"column",justifyContent:e.alignment||"space-between"};return e.onClick?r.createElement("a",{style:t,href:"#",onClick:()=>(0,a.getCurrentTab)().REPL.pexec(e.onClick)},e.children):r.createElement("div",{style:t},e.children)}function l(e){return r.createElement(s,{alignment:"center",flexDirection:"row"},r.createElement(u,Object.assign({},e)),e.text&&r.createElement("span",{className:"even-smaller-text sub-text small-left-pad"},c(e)))}function d(e){return r.createElement(l,Object.assign({},e))}var b=function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((o=o.apply(e,t||[])).next())}))};const m=(0,a.i18n)("plugin-kubectl","view-utilization-table");function p(e,t=!1,n=""){return b(this,void 0,void 0,(function*(){const{parsedOptions:o,REPL:a}=e,r=o.l||o.selector||o.label,i=r?`-l ${r}`:"",c=o.context?`--context ${o.context}`:"",u="{'\\\\t'}",s=`kubectl ${c} get nodes ${i} ${(t?"--field-selector=spec.unschedulable=false":"")+(n?t?"":`--field-selector=metadata.name=${n}`:"")} -o=jsonpath={range .items[*]}{.metadata.name}${u}{.status.allocatable.cpu}${u}{.status.allocatable.memory}${u}{.status.capacity.cpu}${u}{.status.capacity.memory}{'\\\\n'}{end}`;return function(e,t,n){return{title:"Nodes",header:{name:"Node",attributes:[{value:"CPU"},{value:"Memory"}]},body:e.split(/\n/).map((e=>{const[o,a,r,i,c]=e.split(/\t/);return{name:o,onclick:`kubectl get node ${o} -o yaml ${n} ${t}`,attributes:[{key:"cpuAllocatable",value:a},{key:"memoryAllocatable",value:r},{key:"cpuCapacity",value:i},{key:"memoryCapacity",value:c}]}}))}}(yield a.qexec(s),i,c)}))}function y(e,t,n=0){e.command=0===n?e.command.replace(t,""):e.command.replace(new RegExp(`${t}\\s+\\S+`),""),e.argv.splice(e.argv.indexOf(t),n+1)}function h(e,t){return b(this,void 0,void 0,(function*(){if(e.parsedOptions.summary)return function(e,t){return b(this,void 0,void 0,(function*(){y(e,"--summary");const n=yield t(e);return{mode:"raw",content:{cpuFrac:n.body.reduce(((e,t)=>e+o._b.cpuFraction(t.attributes[1].value)),0)/n.body.length/100,memFrac:n.body.reduce(((e,t)=>e+o._b.cpuFraction(t.attributes[3].value)),0)/n.body.length/100}}}))}(e,t);const[n,a]=yield Promise.all([t(e),p(e,!0)]);n.header.attributes.push({outerCSS:"hide-with-sidecar not-displayed",key:"Allocatable CPU",value:m("Allocatable CPU")}),n.header.attributes.push({outerCSS:"hide-with-sidecar not-displayed",key:"Allocatable Memory",value:m("Allocatable Memory")});const r=n.header.attributes.findIndex((e=>"CPU(cores)"===e.key));r>=0&&(n.header.attributes[r].outerCSS=`${n.header.attributes[r].outerCSS||""} hide-with-sidecar`);const c=n.header.attributes.findIndex((e=>"MEMORY(bytes)"===e.key));c>=0&&(n.header.attributes[c].outerCSS=`${n.header.attributes[c].outerCSS||""} hide-with-sidecar`);const u=n.header.attributes.findIndex((e=>"MEMORY%"===e.key));return n.header.attributes[u].outerCSS=n.header.attributes[u].outerCSS.replace(/hide-with-sidecar/,""),n.body.forEach((t=>{t.onclick=`kubectl top pod --node ${e.REPL.encodeComponent(t.name)}`;const n=t.attributes.find((e=>"CPU(cores)"===e.key));n&&(n.outerCSS=`${n.outerCSS||""} hide-with-sidecar`);const r=t.attributes.find((e=>"CPU%"===e.key));r&&(r.valueDom=d({color:"var(--color-latency-0)",fractionString:r.value,text:!0}));const c=t.attributes.find((e=>"MEMORY%"===e.key));c&&(c.valueDom=d({color:"var(--color-latency-1)",fractionString:c.value,text:!0}));const u=a.body.find((e=>e.name===t.name));u&&(t.attributes[0].valueDom=i(t.attributes[0].value,u.attributes[2].value),t.attributes[2].valueDom=i(t.attributes[2].value,o._b.formatAsBytes(o._b.memShare(u.attributes[3].value))),t.attributes[3].outerCSS=t.attributes[2].outerCSS.replace(/hide-with-sidecar/,""),t.attributes.push({outerCSS:"not-displayed",key:"Allocatable CPU",value:void 0===u?"&emdash;":u.attributes[2].value}),t.attributes.push({outerCSS:"not-displayed",key:"Allocatable Memory",value:void 0===u?"&emdash;":o._b.formatAsBytes(o._b.memShare(u.attributes[3].value))}))})),n}))}var f=function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((o=o.apply(e,t||[])).next())}))};const v=(0,a.i18n)("plugin-kubectl","view-utilization-table");function k(e,t){return f(this,void 0,void 0,(function*(){const{content:n}=yield e.REPL.rexec(`kubectl get pods -o json -n ${yield(0,o.D_)(e)} ${(0,o.xT)(e)}`),a={};return n&&n.items?n.items.filter((e=>e.spec.nodeName===t)).map((e=>e.metadata.name)).reduce(((e,t)=>(e[t]=!0,e)),a):a}))}function S(e){const t=Object.assign({},e);return t.command=t.command+" -A",t.argv=t.argv.slice(0).concat(["-A"]),t}const g=["processing-text","semi-bold"];function C(e,t,n,a,r,i="share"){const c=JSON.parse(JSON.stringify(e.body[0]));c.onclick=!1,c.rowKey=t,c.name=v(t),c.attributes[0].value="share"===i?o._b.formatAsCpu(n):(100*n).toFixed(0)+"%",c.attributes[1].value="share"===i?o._b.formatAsBytes(a):(100*a).toFixed(0)+"%",r&&(c.css=r,c.attributes[0].css=r.join(" "),c.attributes[1].css=r.join(" ")),e.body.push(c)}function x(e,t,n){return f(this,void 0,void 0,(function*(){if(t.body&&t.body.length>0){const a=t.body.reduce(((e,t)=>e+o._b.cpuShare(t.attributes[0].value)),0),r=t.body.reduce(((e,t)=>e+o._b.memShare(t.attributes[1].value)),0);if(C(t,"Total",a,r),n.body&&n.body.length>0){const a=yield(0,o.D_)(e),r=n.body.filter((e=>e.name!==a)),i=r.reduce(((e,t)=>e+o._b.cpuShare(t.attributes[1].value)),0),c=r.reduce(((e,t)=>e+o._b.memShare(t.attributes[2].value)),0);C(t,"Other Namespaces",i,c,g)}}return t}))}function $(e,t){return f(this,void 0,void 0,(function*(){const n=function(e,t,n=!1){return b(this,void 0,void 0,(function*(){const a=yield p(e,n,t),r=a.body.reduce(((e,t)=>e+o._b.cpuShare(t.attributes[2].value)-o._b.cpuShare(t.attributes[0].value)),0),i=a.body.reduce(((e,t)=>e+o._b.cpuShare(t.attributes[2].value)),0);return{cpuOverhead:r,memOverhead:a.body.reduce(((e,t)=>e+o._b.memShare(t.attributes[3].value)-o._b.memShare(t.attributes[1].value)),0),cpuCapacity:i,memCapacity:a.body.reduce(((e,t)=>e+o._b.memShare(t.attributes[3].value)),0)}}))}(e,e.parsedOptions.node),r=e.parsedOptions.node?yield function(e,t){return f(this,void 0,void 0,(function*(){const n=e.parsedOptions.node;if(y(e,"--node",1),(0,o.Dk)(e.parsedOptions)||e.parsedOptions.containers){const[o,a]=yield Promise.all([t(e),k(e,n)]);return o.body&&(o.body=o.body.filter((e=>a[e.name]))),o}{const[o,a,r]=yield Promise.all([t(e),k(e,n),t(S(e))]);return o.body&&(o.body=o.body.filter((e=>a[e.name]))),r.body&&(r.body=r.body.filter((e=>a[e.attributes[0].value]))),x(e,o,r)}}))}(e,t):yield function(e,t){return f(this,void 0,void 0,(function*(){if((0,o.Dk)(e.parsedOptions)||e.parsedOptions.containers)return t(e);{const[n,o]=yield Promise.all([t(e),t(S(e))]);return x(e,n,o)}}))}(e,t);if(!(0,a.isTable)(r))return r;if(0===r.body.length)throw new Error(v("No pods found"));const i=yield(0,o.D_)(e);r.body.forEach((t=>{t.onclick&&(t.onclick=`kubectl top container ${e.REPL.encodeComponent(t.name)} -n ${i} ${(0,o.xT)(e)}`)}));const{cpuOverhead:c,memOverhead:u}=yield n;C(r,"System Overheads",c,u,g);const s=r.body.find((e=>"Total"===e.rowKey)),l=r.body.find((e=>"Other Namespaces"===e.rowKey));if(s&&l){const e=o._b.cpuShare(s.attributes[0].value)+o._b.cpuShare(l.attributes[0].value)+c,t=o._b.memShare(s.attributes[1].value)+o._b.memShare(l.attributes[1].value)+u;C(r,v("Overall Total"),e,t,g)}return r}))}function w(e){return f(this,void 0,void 0,(function*(){const t=e.command.replace("top container","top pod").replace(/(-A|--all-namespaces)/,"")+" --containers",n=yield e.REPL.qexec(t),o=e.argvNoOptions[e.argvNoOptions.indexOf("container")+1];return n.body&&(n.body=n.body.filter((e=>e.name===o)),n.body.forEach((t=>{t.onclick=`kubectl get pod ${e.REPL.encodeComponent(t.name)} -o yaml`}))),n}))}var O=function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{u(o.next(e))}catch(e){r(e)}}function c(e){try{u(o.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}u((o=o.apply(e,t||[])).next())}))};const _=e=>O(void 0,void 0,void 0,(function*(){const t=(yield e.find(`/${o.zh}/kubectl/top/node`,"plugin-kubectl")).$;e.listen(`/${o.zh}/kubectl/top/node-summary`,(e=>O(void 0,void 0,void 0,(function*(){return e.command=e.command.replace(/node-summary/,"node --summary"),e.parsedOptions.summary=!0,h(e,t)}))),o.pb),e.override(`/${o.zh}/kubectl/top/node`,"plugin-kubectl",h,o.pb),e.override(`/${o.zh}/k/top/node`,"plugin-kubectl",h,o.pb),e.override(`/${o.zh}/kubectl/top/pod`,"plugin-kubectl",$,o.pb),e.override(`/${o.zh}/k/top/pod`,"plugin-kubectl",$,o.pb),e.listen(`/${o.zh}/kubectl/top/container`,w,o.pb),e.listen(`/${o.zh}/k/top/container`,w,o.pb)}))}}]);