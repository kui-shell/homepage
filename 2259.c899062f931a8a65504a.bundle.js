(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[2259],{52259:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var a=i(67294),s=i(51173),r=i(62308),n=i(24107),l=function(e,t,i,a){return new(i||(i=Promise))((function(s,r){function n(e){try{d(a.next(e))}catch(e){r(e)}}function l(e){try{d(a.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,l)}d((a=a.apply(e,t||[])).next())}))};class d{constructor(){this.rawOutput=""}getNamespace(e){return l(this,void 0,void 0,(function*(){return(yield e.REPL.qexec("kubectl get ns -o json")).items.map((e=>e.metadata.name)).map(((e,t)=>({id:`ns-${t}`,text:e})))}))}getSvc(e,t){return l(this,void 0,void 0,(function*(){return(yield t.REPL.qexec(`kubectl get svc -n ${e} -o yaml`)).items.map((e=>e.metadata.name)).map(((e,t)=>({id:`svc-${t}`,text:e})))}))}getDeployment(e,t,i){return l(this,void 0,void 0,(function*(){return(yield i.REPL.qexec(`kubectl get deployments -n ${e} -o yaml`)).items.map((e=>e.metadata.name)).map(((e,t)=>({id:`d-${t}`,text:e})))}))}}var o=i(88157);function c(e){let t=[];for(let i=0;i<e.length;i++){let a=e[i];""!==a.name&&(""===a.limitType?t.push({id:i,metric_id:a.name,is_reward:a.reward}):t.push({id:i,metric_id:a.name,is_reward:a.reward,threshold:{type:a.limitType,value:a.limitValue}}))}return t}function h(e,t){let i=[];for(let a=0;a<t.length;a++)i.push({id:`${t[a]}`,version_labels:{destination_workload_namespace:e,destination_workload:t[a]}});return i}var m=i(54329);class p extends a.PureComponent{constructor(e){super(e),this._onToggle=this.onToggle.bind(this),this._onSelect=this.onSelect.bind(this),this._clearSelection=this.clearSelection.bind(this),this.state={isExpanded:!1,selected:[]}}onToggle(e){this.setState({isExpanded:e})}onSelect(e,t){const{selected:i}=this.state;i.includes(t)?this.setState((e=>{const i=e.selected.filter((e=>e!==t));return this.props.onChange(i),{selected:i}})):this.setState((e=>{const i=[...e.selected,t];return this.props.onChange(i),{selected:i}}))}clearSelection(){this.setState({selected:[],isExpanded:!1})}render(){const{selected:e}=this.state;return a.createElement(r.Select,{id:this.props.id,selections:e,onToggle:this._onToggle,onSelect:this._onSelect,onClear:this._clearSelection,variant:r.SelectVariant.typeaheadMulti,placeholderText:this.props.placeholderText,"aria-labelled-by":this.props.ariaLabelledBy,typeAheadAriaLabel:this.props.ariaLabelTypeAhead},this.props.options.map(((e,t)=>a.createElement(r.SelectOption,{key:t,value:e}))))}}var u=function(e,t,i,a){return new(i||(i=Promise))((function(s,r){function n(e){try{d(a.next(e))}catch(e){r(e)}}function l(e){try{d(a.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,l)}d((a=a.apply(e,t||[])).next())}))};class y extends a.Component{constructor(e){super(e),this.kubeMethods=new d,this.GetMetricConfig=new o.Dh,this.handleAddCand=e=>{const t=e.map((e=>e.text));for(let e=0;e<t.length;e++)if(this.state.baseline===t[e])return t.splice(e,1),void this.setState({invalidCandidate:!0,candidates:t});this.setState({invalidCandidate:!1,candidates:t})},this.handleSelectExpType=e=>{console.log("Running "+e+" Experiment")},this.handleAddNs=e=>{if(null==e){this.setState({namespace:"",service:"",baseline:"",candidates:[]});const e=[];this.setState({svcList:e})}else this.setState({namespace:e,service:"",baseline:"",candidates:[]}),setTimeout((()=>u(this,void 0,void 0,(function*(){const[t]=yield Promise.all([this.kubeMethods.getSvc(e,this.args)]);this.setState({svcList:t})}))));this.setState({deployList:[]})},this.handleAddSvc=e=>{if(null==e){this.setState({service:"",baseline:"",candidates:[]});const e=[];this.setState({deployList:e})}else this.setState({service:e,baseline:"",candidates:[]}),setTimeout((()=>u(this,void 0,void 0,(function*(){const[t]=yield Promise.all([this.kubeMethods.getDeployment(this.state.namespace,e,this.args)]);this.setState({deployList:t})}))))},this.handleEdgeServiceChange=e=>{!0===e?this.setState({edgeService:!0}):(this.setState({edgeService:!1}),this.setState({invalidHostGateways:!1}))},this.addHostGatewayPairs=e=>{const t=e.split(";"),i=[];let a=[];for(let e=0;e<t.length;e++)a=t[e].trim().split(","),a[0]="string"==typeof a[0]?a[0].trim():"",a[1]="string"==typeof a[1]?a[1].trim():"",""!==a[0]&&""!==a[1]&&i.push({name:a[0],gateway:a[1]});0===i.length?this.setState({invalidHostGateways:!0}):(this.setState({invalidHostGateways:!1}),this.setState({hostGateways:i}))},this.handleAddBase=e=>{null==e?this.setState({baseline:"",candidates:[]}):this.setState({baseline:e,candidates:[]})},this.deleteCriterion=e=>{this.setState((t=>({criteria:t.criteria.filter(((t,i)=>i!==e))})))},this.handleMetricName=(e,t)=>{let i,a;if(null==e)i="",a="";else{i=e.name,a="Ratio";for(let t=0;t<this.state.countMetricsList.length;t++)this.state.countMetricsList[t].name===e.name&&(a="Counter")}const s=[...this.state.criteria];s[t]=Object.assign(Object.assign({},s[t]),{name:i,type:a}),this.setState({criteria:s})},this.handleLimitTypeChange=(e,t)=>{const i=e?"relative":"absolute",a=[...this.state.criteria];a[t]=Object.assign(Object.assign({},a[t]),{limitType:i}),this.setState({criteria:a})},this.handleLimitValChange=(e,t)=>{const i=""===e?0:parseFloat(e),a=[...this.state.criteria];a[t]=Object.assign(Object.assign({},a[t]),{limitValue:i}),this.setState({criteria:a})},this.handleRewardChange=e=>{const t=[...this.state.criteria];t[e]=Object.assign(Object.assign({},t[e]),{reward:!t[e].reward}),this.setState((e=>({criteria:t,disableReward:!e.disableReward})))},this.args=e,this.state={showCriteria:!1,invalidCandidate:!1,name:"",type:m.K.hil,namespace:"",service:"",baseline:"",candidates:[],criteria:[{name:"",type:"",reward:!1,limitType:"",limitValue:0}],disableReward:!1,edgeService:!0,hostGateways:[],invalidHostGateways:!1,nsList:[],svcList:[],deployList:[],countMetricsList:[],ratioMetricsList:[],totalMetricsList:[]},setTimeout((()=>u(this,void 0,void 0,(function*(){const[e]=yield Promise.all([this.kubeMethods.getNamespace(this.args)]);this.setState({nsList:e})})))),setTimeout((()=>u(this,void 0,void 0,(function*(){const[e]=yield Promise.all([this.GetMetricConfig.getCounterMetrics(this.args)]);this.setState({countMetricsList:e})})))),setTimeout((()=>u(this,void 0,void 0,(function*(){const[e]=yield Promise.all([this.GetMetricConfig.getRatioMetrics(this.args)]);this.setState({ratioMetricsList:e})})))),this.submitForm=this.submitForm.bind(this),this.handleNameChange=this.handleNameChange.bind(this),this.addCriterion=this.addCriterion.bind(this)}componentDidCatch(e,t){console.error(e,t)}handleNameChange(e){console.log(e.target.value),this.setState({name:e.target.value})}handleSplitCand(e){const t=e.target.value.split(","),i=[];for(let e=0;e<t.length;e++)i.push({id:`c-${e}`,text:t[e].trim()});this.handleAddCand(i)}addCriterion(){this.setState({totalMetricsList:this.state.countMetricsList.concat(this.state.ratioMetricsList)}),this.state.showCriteria?this.setState((e=>({criteria:[...e.criteria,{name:"",type:"",reward:!1,limitType:"",limitValue:0}]}))):this.setState({showCriteria:!0})}submitForm(){const e=function(e,t,i){return{start_time:e,service_name:t.service,metric_specs:{counter_metrics:t.countMetricsList,ratio_metrics:t.ratioMetricsList},criteria:c(t.criteria),baseline:{id:`${t.baseline}`,version_labels:{destination_workload_namespace:t.namespace,destination_workload:t.baseline}},candidates:h(t.namespace,t.candidates),traffic_control:{max_increment:25},edgeServiceInformation:{edgeService:t.edgeService,hostGateways:t.hostGateways}}}(new Date(Date.now()-2e4).toISOString(),this.state,this.args);s.eventChannelUnsafe.emit("/get/decision",e)}preventFormRefresh(e){e.preventDefault(),document.getElementById("submitform").setAttribute("disabled",""),document.getElementById("addcriterion").setAttribute("disabled","")}render(){const{criteria:e}=this.state;return a.createElement("div",{className:"padding-content scrollable scrollable-auto"},a.createElement("h2",null,"iter8 Experiment Configurations"),a.createElement(r.Form,{className:"plugin-iter8-formProps",onSubmit:this.preventFormRefresh},a.createElement(r.FormGroup,{style:{width:350},label:"Name",helperText:"Name to identify the experiment",helperTextInvalid:"This is a required field",isRequired:!0,fieldId:"exprForm-id-2"},a.createElement(r.TextInput,{id:"experiment-name",placeholder:"Eg: experiment_v1_v2",onChange:this.handleNameChange,type:"text"})),a.createElement(r.FormGroup,{style:{width:350},label:"Experiment Type",helperText:"Type of experiment to be conducted",isRequired:!0,fieldId:"exprForm-id-3"},a.createElement(r.FormSelect,{id:"experiment-type-select",placeholder:"Select an Experiment Type",onChange:e=>this.handleSelectExpType(e)},[m.K.hil].map(((e,t)=>a.createElement(r.FormSelectOption,{key:t,label:e}))))),a.createElement(r.FormGroup,{style:{width:350},label:"Service Namespace",helperText:"Namespace where the target service resides",isRequired:!0,fieldId:"exprForm-id-4"},a.createElement(r.FormSelect,{id:"namespace-select",placeholder:"Select a Namespace",onChange:e=>this.handleAddNs(e)},this.state.nsList.map(((e,t)=>a.createElement(r.FormSelectOption,{key:t,label:e?e.text:""}))))),a.createElement(r.FormGroup,{label:"Edge Service",fieldId:"exprForm-id-5"},a.createElement(r.Switch,{"aria-label":"",id:"edge-service",isChecked:!0,label:"False",labelOff:"True",onChange:e=>this.handleEdgeServiceChange(e)})),a.createElement(r.FormGroup,{style:{width:350},label:"Host/Gateway pairs",helperText:"Enter Host and gateway names for edge service",helperTextInvalid:"Invalid Host Gateway Pairs. Try again",validated:this.state.invalidHostGateways?"error":"default",fieldId:"exprForm-id-6"},a.createElement(r.TextInput,{id:"hostGateway",placeholder:"Eg: hostname1, gatewayname1; hostname2, gatewayname2",onChange:e=>this.addHostGatewayPairs(e),type:"text",isDisabled:!this.state.edgeService})),a.createElement(r.FormGroup,{style:{width:350},label:"Service",helperText:"Name of the target service",isRequired:!0,fieldId:"exprForm-id-7"},a.createElement(r.FormSelect,{id:"service-select",placeholder:"Select a Service",onChange:e=>this.handleAddSvc(e)},this.state.svcList.map(((e,t)=>a.createElement(r.FormSelectOption,{key:t,label:e?e.text:""}))))),a.createElement(r.FormGroup,{style:{width:350},label:"Baseline Deployment",helperText:"The version of the service to be used as experimental baseline",isRequired:!0,fieldId:"exprForm-id-8"},a.createElement(r.FormSelect,{id:"baseline-select",placeholder:"Select a Baseline Deployment",onChange:e=>this.handleAddBase(e)},this.state.deployList.map(((e,t)=>a.createElement(r.FormSelectOption,{key:t,label:e?e.text:""}))))),a.createElement(r.FormGroup,{style:{width:350},label:"Select Candidate Deployment(s)",validated:this.state.invalidCandidate?"error":"default",helperTextInvalid:"Cannot select same version as experimental baseline.",fieldId:"exprForm-id-9"},a.createElement("p",null,a.createElement("span",null," Candidate Deployment(s) "),a.createElement("br",null),a.createElement("span",{className:"helper"}," The version(s) of the service to be used as experimental candidate(s).")),a.createElement(p,{id:"candidates-select",options:this.state.deployList.map((e=>e?e.text:"")),onChange:e=>this.handleAddCand(e)})),a.createElement(r.FormGroup,{label:"or Add Candidate Deployment(s) below:",helperText:"Comma separated candidate names",fieldId:"exprForm-id-10"},a.createElement(r.TextInput,{id:"candidate-name",placeholder:"reviews_v3, reviews_v4",onChange:e=>this.handleSplitCand(e),type:"text"})),this.state.showCriteria?a.createElement("div",{style:{position:"relative"}},e.map(((e,t)=>{const i=`criterion-${t}`,s=`limitType-${t}`,l=`limitValue-${t}`,d=`deletecriterion-${t}`,o=`checkbox-${t}`;return a.createElement("div",{style:{padding:20},key:t},a.createElement("h5",null," ",`Criterion #${t+1}`),a.createElement(r.FormGroup,{fieldId:`exprForm-id-11-${t}-1`,label:"Metric name",helperText:"Metric to be used for this critetion"},a.createElement(r.FormSelect,{id:i,onChange:e=>this.handleMetricName(e,t)},this.state.totalMetricsList.map(((e,t)=>a.createElement(r.FormSelectOption,{key:t,label:e?e.name:""}))))),a.createElement(n.Vp,{type:"ok"},""===e.type?"...":e.type),a.createElement(n.Vp,{type:"warning"},e.reward?"Reward":""===e.limitType?"Absolute Threshold":`${e.limitType} threshold`),a.createElement("br",null),a.createElement("span",{className:"child"},e.limitType?null:this.handleLimitTypeChange(!1,t),a.createElement(r.FormGroup,{fieldId:`exprForm-id-11-${t}-2`,label:"Threshold Type"},a.createElement(r.Switch,{"aria-label":"",id:s,isDisabled:e.reward,label:"Absolute",labelOff:"Relative",onChange:e=>this.handleLimitTypeChange(e,t)}))),a.createElement("span",{className:"child"},a.createElement(r.FormGroup,{fieldId:`exprForm-id-11-${t}-3`,label:"Limit Value",helperText:"Set a value for the threshold selected",helperTextInvalid:"Limit values can only be set for non-reward metrics",validated:e.reward&&0!==e.limitValue?"error":"default"},a.createElement(r.TextInput,{id:l,isDisabled:e.reward,onChange:e=>this.handleLimitValChange(e,t)}))),a.createElement(r.FormGroup,{fieldId:`exprForm-id-11-${t}-4`,label:"Set as reward"},a.createElement(r.Checkbox,{id:o,isDisabled:!e.reward&&this.state.disableReward||"Counter"===e.type,onChange:()=>this.handleRewardChange(t)})),a.createElement(n.zx,{id:d,size:"small",kind:"danger",onClick:()=>this.deleteCriterion(t)},`Delete Criterion ${t+1}`))}))):null,a.createElement(r.ActionGroup,null,a.createElement(r.FormGroup,{style:{width:350},fieldId:"exprForm-id-12"},a.createElement(n.zx,{id:"addcriterion",size:"default",kind:"primary",onClick:this.addCriterion},"Add Criterion")),a.createElement(r.FormGroup,{style:{width:350},fieldId:"exprForm-id-13"},a.createElement(n.zx,{id:"submitform",type:"submit",size:"default",onClick:this.submitForm},"Create Experiment")))))}}},54329:(e,t,i)=>{"use strict";var a;i.d(t,{K:()=>a,t:()=>s}),function(e){e.hil="Human In the Loop",e.automated="Automated"}(a||(a={}));const s={chart:{type:"line",stacked:!1,height:350,zoom:{type:"x",enabled:!0,autoScaleYaxis:!0},toolbar:{autoSelected:"zoom"}},stroke:{width:2,curve:"straight",dashArray:[9]},dataLabels:{enabled:!1},markers:{size:3},title:{text:"",align:"left"},yaxis:{labels:{formatter:function(e){return(e/1e6).toFixed(0)}}},xaxis:{type:"datetime",categories:[],labels:{datetimeFormatter:{year:"yyyy",month:"MMM 'yy",day:"dd MMM",hour:"HH:mm"}}},tooltip:{shared:!1,y:{formatter:function(e){return(e/1e6).toFixed(0)}}}}}}]);