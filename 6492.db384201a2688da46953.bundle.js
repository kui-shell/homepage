(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[6492],{16492:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createWindow:()=>C,initHeadless:()=>k,main:()=>_});var o=n(11227),i=n.n(o),r=n(99007),s=n(12993),c=n(26470),l=n(8746);const a=i()("main/localStorage");a("loading"),a("modules loaded");const d=()=>{a("init");const e=(0,c.join)((0,l.CF)(),"kui-local-storage.json");let t;a("userData %s",e);try{const n=(0,s.readFileSync)(e).toString();try{t=JSON.parse(n)}catch(e){throw a("error parsing userData",n),e}}catch(e){if("ENOENT"!==e.code)throw a("error reading userData"),e;t={}}a("parsed userData");const n=()=>{try{a("flush"),(0,s.writeFileSync)(e,JSON.stringify(t)),a("flush done")}catch(e){"ENOENT"===e.code?a("we decided not to initialize the store, but a plugin is trying to write to it"):console.error(e)}},o={getItem:e=>t[e]||null,setItem:(e,o)=>(a("setItem",e,o),t[e]=o,n(),o),removeItem:e=>{const o=t[e];return delete t[e],n(),o}};return a("init done"),o};var u=n(46202);const g=i()("core/util/mimic-dom");g("loading");var h=n(9034),m=n(41881),v=n(64974),f=n(7716),p=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{l(o.next(e))}catch(e){r(e)}}function c(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}l((o=o.apply(e,t||[])).next())}))};const y=i()("main/headless");y("loading"),(0,v.setMedia)(v.Media.Headless);let w=0;f.on("uncaughtException",(e=>{console.error("Uncaught Exception",e)})),f.on("exit",(e=>{y("exiting",e)}));let E=1;f.env.DEVMODE&&(E=2);const x=/--command-context/;let S;const b=console.log,I=console.error;y("modules loaded");let D=!1;const O=(e,t)=>o=>p(void 0,void 0,void 0,(function*(){if(t&&t.rethrowErrors)throw o;const i=o.code||o.statusCode;y("failure",i,o);let r=Promise.resolve();if(f.env.TEST_CODE_ONLY&&o.statusCode)I(o.statusCode);else{let e;if(m.ZP.isUsageError(o))e=m.ZP.getFormattedMessage(o);else{const{oopsMessage:t}=yield Promise.resolve().then(n.bind(n,25732));e=t(o)}if("string"==typeof e){const t=yield n.e(4431).then(n.t.bind(n,44431,23));f.env.TEST_INCLUDE_CODE&&o.statusCode?I(t.blue(o.statusCode.toString())+" "+t.red(e)):I(t.red(e))}else{const{print:t}=yield n.e(1844).then(n.bind(n,31844));r=t(e,I,f.stderr,void 0,"error")||Promise.resolve()}}return r.then((()=>(D||(w="number"==typeof i?i:1,f.env.KUI_REPL_MODE||(f.exit(w>128?w-256:w),e&&e())),!1)))}));let P;const C=(e,t,o)=>p(void 0,void 0,void 0,(function*(){try{D=!0;const{setGraphicalShellIsOpen:i}=yield n.e(1844).then(n.bind(n,31844));i();const r=e;S&&r.push(S),P(r,t,o)}catch(e){I(e)}}));const _=(e,t,o=f.argv,i)=>p(void 0,void 0,void 0,(function*(){y("main");const s=(0,h.init)(),c=yield function(){return p(this,void 0,void 0,(function*(){const{init:e}=yield Promise.resolve().then(n.bind(n,32578));yield e()}))}(),l=o.find((e=>x.test(e)));y("commandContext",l),!S&&l&&(S=l);const a=o.slice(E).filter((e=>!x.test(e)&&"--kui-headless"!==e&&"-v"!==e&&"--raw-output"!==e&&"--no-color"!==e&&"--no-colors"!==e&&"--color=always"!==e&&"--ui"!==e));y("argv",a);const{quit:m}=e;P=t.createWindow,function(){g("mimicDom"),n.g.window={navigator:{userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:74.0) Gecko/20100101 Firefox/74.0"}};try{n.g.localStorage=d(),n.g.sessionStorage=d(),g("successfully initialized persistent localStorage")}catch(e){g("error initializing persistent localStorage",e);const t={},o={};n.g.localStorage={setItem:(e,n)=>(t[e]=n,n),getItem:e=>t[e]||null},n.g.sessionStorage={setItem:(e,t)=>(o[e]=t,t),getItem:e=>o[e]||null}}finally{n.g.window.localStorage=localStorage,n.g.window.sessionStorage=sessionStorage}window.addEventListener=()=>!0;const e=()=>new u.Z;n.g.document={body:e(),getElementById:t=>e(),createElement:t=>{const n=e();return n.nodeType=t,"table"===t&&(n.rows=[]),n},addEventListener:()=>!0,createTextNode:t=>{const n=e();return n.innerText=t,n},querySelector:t=>e()},g("mimicDom done")}();const v=e=>Promise.resolve((0,r.exec)(e,i)).then((e=>t=>p(void 0,void 0,void 0,(function*(){if(y("success!"),f.env.KUI_REPL_MODE)return y("returning repl mode result"),t;const{print:o}=yield n.e(1844).then(n.bind(n,31844));yield o(t,b,f.stdout),D?y("graphical shell is open"):(e(),f.exit(w))})))(m));return y("bootstrap"),Promise.all([s,c]).then((([e])=>p(void 0,void 0,void 0,(function*(){y("plugins initialized"),e&&(yield(e=>p(void 0,void 0,void 0,(function*(){if(e)try{y("setting command context",e),(yield Promise.resolve().then(n.bind(n,81933))).setDefaultCommandContext(JSON.parse(e.substring(e.indexOf("=")+1)))}catch(e){y("Error initializing command context",e)}})))(S));const t=e=>O(m,i)(e);if(e&&(y("invoking plugin preloader"),yield(0,h.preload)(),y("invoking plugin preloader... done")),(e=>0===e.length||1===e.length&&/(-h)|(--help)/.test(e[0]))(a))return y("insufficient args, invoking help command"),v("help");const o=a.map((e=>e.match(/\s+/)?`"${e}"`:e)).join(" ").trim();if(o&&o.length>0)return y("about to execute command"),v(o).catch(t);y("exiting, no command"),f.env.KUI_REPL_MODE||f.exit(0)})))).catch(O(m,i))}));function k(e,t=!1,o=!1,i){if(t||o){y("initHeadless");const t={quit:()=>f.exit(0)};try{return _(t,{createWindow:(e,t,o)=>p(this,void 0,void 0,(function*(){const{createWindow:i}=yield Promise.all([n.e(8575),n.e(7061)]).then(n.bind(n,57061));return i(!0,e,t,o)}))},e,i)}catch(e){if(console.error("Internal Error, please report this bug:"),console.error(e),f.env.KUI_REPL_MODE)throw e;f.exit(1)}}}}}]);