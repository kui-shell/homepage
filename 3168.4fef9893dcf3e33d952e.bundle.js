(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[3168],{12617:t=>{self,t.exports=(()=>{"use strict";var t={775:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.FitAddon=void 0;var i=function(){function t(){}return t.prototype.activate=function(t){this._terminal=t},t.prototype.dispose=function(){},t.prototype.fit=function(){var t=this.proposeDimensions();if(t&&this._terminal){var e=this._terminal._core;this._terminal.rows===t.rows&&this._terminal.cols===t.cols||(e._renderService.clear(),this._terminal.resize(t.cols,t.rows))}},t.prototype.proposeDimensions=function(){if(this._terminal&&this._terminal.element&&this._terminal.element.parentElement){var t=this._terminal._core;if(0!==t._renderService.dimensions.actualCellWidth&&0!==t._renderService.dimensions.actualCellHeight){var e=window.getComputedStyle(this._terminal.element.parentElement),i=parseInt(e.getPropertyValue("height")),n=Math.max(0,parseInt(e.getPropertyValue("width"))),o=window.getComputedStyle(this._terminal.element),s=i-(parseInt(o.getPropertyValue("padding-top"))+parseInt(o.getPropertyValue("padding-bottom"))),r=n-(parseInt(o.getPropertyValue("padding-right"))+parseInt(o.getPropertyValue("padding-left")))-t.viewport.scrollBarWidth;return{cols:Math.max(2,Math.floor(r/t._renderService.dimensions.actualCellWidth)),rows:Math.max(1,Math.floor(s/t._renderService.dimensions.actualCellHeight))}}}},t}();e.FitAddon=i}},e={};return function i(n){if(e[n])return e[n].exports;var o=e[n]={exports:{}};return t[n](o,o.exports,i),o.exports}(775)})()},33168:(t,e,i)=>{"use strict";i.d(e,{oI:()=>U,ZP:()=>F});var n,o=i(67294),s=new Uint8Array(16);function r(){if(!n&&!(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(s)}const a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const h=function(t){return"string"==typeof t&&a.test(t)};for(var l=[],d=0;d<256;++d)l.push((d+256).toString(16).substr(1));const c=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(l[t[e+0]]+l[t[e+1]]+l[t[e+2]]+l[t[e+3]]+"-"+l[t[e+4]]+l[t[e+5]]+"-"+l[t[e+6]]+l[t[e+7]]+"-"+l[t[e+8]]+l[t[e+9]]+"-"+l[t[e+10]]+l[t[e+11]]+l[t[e+12]]+l[t[e+13]]+l[t[e+14]]+l[t[e+15]]).toLowerCase();if(!h(i))throw TypeError("Stringified UUID is invalid");return i};const u=function(t,e,i){var n=(t=t||{}).random||(t.rng||r)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){i=i||0;for(var o=0;o<16;++o)e[i+o]=n[o];return e}return c(n)};var m=i(51173),p=i(24107),g=i(12320),f=i(12617),b=i(79895),v=i(21274),y=i(53156);const w=(0,m.i18n)("plugin-kubectl");class T extends o.PureComponent{toolbarButtonsForError(t){return"Stopped"===t||"Error"===t?[{mode:"retry-streaming",label:w("Retry"),kind:"view",icon:o.createElement(p.PJ,{icon:"Retry",onClick:()=>this.showContainer(this.state.container)}),command:()=>{}}]:[]}toolbarButtonsForStreaming(t){return[]}toolbarButtons(t){return this.toolbarButtonsForError(t).concat(this.toolbarButtonsForStreaming(t),this.containerList())}supportsAllContainers(){return!1}componentWillUnmount(){this.state.job&&this.state.job.abort()}updateToolbar(t){this.props.toolbarController.willUpdateToolbar(this.toolbarText(t),this.toolbarButtons(t),!0)}showContainer(t){this.setState({container:t})}containerOptions(){const{containers:t=[]}=this.props.pod.spec,e=t.map((t=>({label:t.name,isSelected:this.state.container===t.name,hasDivider:!1,handler:()=>this.showContainer(t.name)}))).concat(this.supportsAllContainers()&&1!==t.length?[{label:w("All Containers"),isSelected:this.isAllContainers(),hasDivider:!0,handler:()=>this.showContainer(void 0)}]:[]);return o.createElement(p.vb,{isPlain:!0,actions:e,className:"kui--repl-block-right-element"})}isAllContainers(){return!this.state.container}containerList(){return[{mode:"container-list",label:"Select a container",kind:"view",command:()=>{},icon:this.containerOptions()}]}}var C=i(7716),S=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{h(n.next(t))}catch(t){s(t)}}function a(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}))};const x=(0,m.i18n)("plugin-kubectl","exec"),_="terminal";function I(t,e){if(/^#[0-9a-fA-F]{6}$/.test(t)){return`rgba(${parseInt(t.slice(1,3),16)},${parseInt(t.slice(3,5),16)},${parseInt(t.slice(5,7),16)},${e})`}return t}class U extends T{constructor(t){super(t),this.cleaners=[],this.isIdle=!0,this._unmounted=!1,this._initInProgressForContainer=!1,this._initCount=0,this.state={container:this.defaultContainer(),dom:void 0,xterm:void 0,doResize:void 0,perTerminalCleaners:[],isLive:"Paused",isTerminated:!1,waitingForHysteresis:!1,gotSomeData:!1,job:void 0,streamUUID:void 0},this.updateToolbar(this.state.isLive);const{uuid:e}=this.props.tab,i=()=>{this.doFocus(),this.doXon()},n=`/mode/focus/on/tab/${e}/mode/${this.mode()}`;m.eventChannelUnsafe.on(n,i),this.cleaners.push((()=>m.eventChannelUnsafe.off(n,i)));const o=this.doXoff.bind(this),s=`/mode/focus/off/tab/${e}/mode/${this.mode()}`;m.eventChannelUnsafe.on(s,o),this.cleaners.push((()=>m.eventChannelUnsafe.off(s,o)));const r=this.onWindowResize.bind(this);window.addEventListener("resize",r),this.cleaners.push((()=>window.removeEventListener("resize",r)));const a=this.onTabLayoutChange.bind(this);m.eventBus.onTabLayoutChange(e,a),this.cleaners.push((()=>m.eventBus.offTabLayoutChange(e,a)))}defaultContainer(){if(this.props.args.argsForMode){const t=(0,y.ZO)(this.props.args.argsForMode,"exec");if(t)return t}return this.props.pod.spec.containers[0].name}mode(){return _}doXon(){this.state&&this.state.job&&setTimeout((()=>this.state.job.xon()))}doXoff(){this.state&&this.state.job&&setTimeout((()=>this.state.job.xoff()))}doFocus(){this.state&&this.state.xterm&&setTimeout((()=>{this.state.xterm.focus()}))}static injectTheme(t,e){const i=getComputedStyle(e),n=(t,e="color")=>i.getPropertyValue(`--${e}-${t}`).trim(),o={foreground:n("text-01"),background:n("base01"),cursor:n("support-01"),selection:I(n("selection-background"),.3),black:n("black"),red:n("red"),green:n("green"),yellow:n("yellow"),blue:n("blue"),magenta:n("magenta"),cyan:n("cyan"),white:n("white"),brightBlack:n("black"),brightRed:n("red"),brightGreen:n("green"),brightYellow:n("yellow"),brightBlue:n("blue"),brightMagenta:n("magenta"),brightCyan:n("cyan"),brightWhite:n("white")};t.setOption("theme",o),t.setOption("fontFamily",n("monospace","font"));try{const e=getComputedStyle(document.querySelector("body .repl .repl-input input"));t.setOption("fontSize",parseInt(e.fontSize.replace(/px$/,""),10)),t.setOption("fontWeight",400),t.setOption("fontWeightBold",600)}catch(t){console.error("Error setting terminal font size",t)}}onWindowResize(){this.state.xterm&&this.state.doResize()}onTabLayoutChange(t){this.state.xterm&&!t.isSidecarNowHidden&&this.state.doResize()}componentWillUnmount(){this._unmounted=!0,super.componentWillUnmount(),this.disposeTerminal(),this.cleaners.forEach((t=>t()))}disposeTerminal(){this.state.xterm.dispose(),this.state.perTerminalCleaners.forEach((t=>t())),this.setState({xterm:void 0,perTerminalCleaners:[]})}componentDidUpdate(){this.updateToolbar(this.state.isLive),this.state.job||this.state.isTerminated||this.initStream()}abortPriorJob(){if(this.state.job){const t=this.state.job;setTimeout((()=>t.abort()),5e3)}}showContainer(t,e){this.setState((i=>(this.abortPriorJob(),Object.assign({container:t,job:void 0,streamUUID:void 0,isTerminated:!1},e?e(i):{}))))}static getDerivedStateFromProps(t,e){return e.dom&&!e.xterm?U.initTerminal(e.dom):e}toolbarText(t){return this.state.isTerminated?{type:"error",text:x("The terminal connection has closed.")}:this.state.job?"Idle"===this.state.isLive?{type:"warning",text:x("Connection is idle, and will expire shortly. Connected to container X.",this.state.container)}:{type:"info",text:x("Connected to container X.",this.state.container)}:{type:"warning",text:x("Please wait. Connecting to container X.",this.state.container)}}ptyCommand(){const{args:t,pod:e}=this.props,{container:i}=this.state,n=t.argsForMode&&(0,y.QG)(t.argsForMode,t.argsForMode.command)||(0,y.QG)(this.props.args,`${(0,b.fY)(this.props.args)} exec -it ${e.metadata.name} -c ${i} -n ${e.metadata.namespace} -- sh`);return t.argsForMode&&t.argsForMode.command&&(t.argsForMode.command=void 0),{command:n}}gotSomeData(t){this.state.gotSomeData||this.setState((e=>{if(!e.gotSomeData&&e.streamUUID===t)return{gotSomeData:!0}}))}indicate(t){this.updateToolbar(t),this.setState({isLive:t})}initiateIdleCountdown(){this.indicate("Idle"),this.idleTimeout=setTimeout((()=>{this.abortPriorJob()}),3e5)}initiateIdleTimer(){return setTimeout((()=>this.initiateIdleCountdown()),9e5)}initStream(){const{tab:{REPL:t}}=this.props,{xterm:e}=this.state,i=u();if(this._initInProgressForContainer===this.state.container)return;this._initCount++>0&&e.reset(),this._initInProgressForContainer=this.state.container;const{command:n,isLive:o="Live"}=this.ptyCommand();t.qexec(n,void 0,void 0,{tab:this.props.tab,onInit:()=>{if(!this._unmounted)return this._initInProgressForContainer=!1,t=>{this.idleTimeout&&(clearTimeout(this.idleTimeout),this.indicate(o),this.idleTimeout=this.initiateIdleTimer()),"string"==typeof t&&this.state.streamUUID===i&&(this.gotSomeData(i),e.write(t))}},onReady:t=>{this._unmounted||(e.onData((e=>{this._unmounted||this.state.streamUUID!==i||t.write(e)})),this.doFocus(),setTimeout((()=>{this.state.isTerminated||this.setState((t=>{if(t.streamUUID===i)return{waitingForHysteresis:!1}}))}),1500),this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=this.initiateIdleTimer(),this.setState({job:t,streamUUID:i,isLive:o,waitingForHysteresis:!0}))},onExit:t=>{this._unmounted||this.setState((e=>{if(e.streamUUID===i){const i=0===t?"Stopped":"Error";return this.updateToolbar(i),{job:void 0,streamUUID:void 0,container:e.container,isLive:i,isTerminated:!0}}}))}}).catch((t=>{this._unmounted||this.state.streamUUID!==i||(console.error(t),this.updateToolbar("Error"))}))}isAllContainers(){return super.isAllContainers()&&!this.state.isTerminated}static initTerminal(t){const e=(0,p.w6)()||C.env.RUNNING_SHELL_TEST||C.env.RUNNING_KUI_TEST?"dom":"canvas",i=new g.Terminal({scrollback:1e3,rendererType:e}),n=[],o=()=>U.injectTheme(i,t);o(),m.eventChannelUnsafe.on("/theme/change",o),n.push((()=>m.eventChannelUnsafe.on("/theme/change",o)));const s=new f.FitAddon;i.loadAddon(s),i.open(t);const r=()=>{try{s.fit()}catch(t){console.error(t)}};r();const a=new ResizeObserver((function(t){t.every((t=>t.contentRect.width>0&&t.contentRect.height>0))&&setTimeout(r)}));return a.observe(t),n.push((()=>a.disconnect())),{xterm:i,doResize:r,perTerminalCleaners:n}}needsHysteresis(){return!1}nothingToShow(){return o.createElement(o.Fragment,null)}maybeNothingToShow(){if(this.needsHysteresis()){if(this.state.waitingForHysteresis||!this.state.xterm||!this.state.job)return o.createElement(o.Fragment,null);if(!this.state.gotSomeData)return this.nothingToShow()}}render(){return this.state.dom&&!this.state.xterm?o.createElement(p.gb,null):o.createElement("div",{className:"kui--full-height kui--terminal kui--relative-positioning","data-needs-hysteresis":this.needsHysteresis(),"data-got-some-data":this.state.gotSomeData,ref:t=>this.setState({dom:t})},this.maybeNothingToShow())}}const F={when:t=>(0,v.th)(t)&&!t.isSimulacrum,mode:{mode:_,label:"Terminal",content:function(t,e,i){return S(this,void 0,void 0,(function*(){return{react:function(n){return o.createElement(U,{tab:t,pod:e,args:i,toolbarController:n})}}}))}}}}}]);