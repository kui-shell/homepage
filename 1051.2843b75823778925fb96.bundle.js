(self.webpackChunkkui_shell=self.webpackChunkkui_shell||[]).push([[1051,2383,7208],{51153:(e,t,i)=>{"use strict";i.r(t),i.d(t,{doExec:()=>L});var n=i(11227),o=i.n(n),s=i(72045),r=i(12320),l=i(51173);var a=i(36065),c=i(95233);function d(e,t,i){for(;e.length<i;)e=t+e;return e}function u(e){const{classList:t,style:i,textContent:n}=function(e){const t=[],i={};let n;e.isBold()&&t.push("xterm-bold"),e.isItalic()&&t.push("xterm-italic"),e.isDim()&&t.push("xterm-dim"),e.isUnderline()&&t.push("xterm-underline"),n=e.isInvisible()?" ":e.getChars()||" ";let o=e.getFgColor(),s=e.getFgColorMode(),r=e.getBgColor(),l=e.getBgColorMode();const a=!!e.isInverse();if(a){const e=o;o=r,r=e;const t=s;s=l,l=t}switch(s){case 16777216:case 33554432:t.push(`xterm-fg-${o}`);break;case 50331648:i.color=`#${d(o.toString(16),"0",6)}`;break;case 0:default:a&&t.push("xterm-fg-257")}switch(l){case 16777216:case 33554432:t.push(`xterm-bg-${r}`);break;case 50331648:i["background-color"]=`#${d(r.toString(16),"0",6)}`;break;case 0:default:a&&t.push("xterm-bg-257")}return{classList:t,textContent:n,style:i}}(e);return{innerText:e.getChars(),classList:t,style:i,textContent:n}}function f(e,t){return!(!e.isAttributeDefault()||!t.isAttributeDefault())||e.getFgColorMode()===t.getFgColorMode()&&e.getBgColorMode()===t.getBgColorMode()&&e.isBold()===t.isBold()&&e.isItalic()===t.isItalic()&&e.isDim()===t.isDim()&&e.isUnderline()===t.isUnderline()&&e.isBlink()===t.isBlink()&&e.isInvisible()===t.isInvisible()}function h(e,t,i,n){let o;e.getCell(0,t),n[n.length-1]&&f(t,i)?(o=n[n.length-1],o.innerText+=t.getChars()):(o=u(t),n.push(o));for(let s=1;s<e.length;s++)e.getCell(s-1,t),e.getCell(s,i),f(t,i)?o.innerText+=i.getChars():(o=u(i),n.push(o))}function p(e){const t=[],i=e.buffer.active.getNullCell(),n=e.buffer.active.getNullCell(),o=function(e,t){let i=e.buffer.active.length-1;for(;i>=0;){const n=e.buffer.active.getLine(i);for(let e=0;e<n.length;e++)if(n.getCell(e,t),0!==t.getCode())return i;i--}return-1}(e,n)+1;let s;for(let r=0;r<o;r++){const o=e.buffer.active.getLine(r);o.isWrapped&&void 0!==s?h(o,i,n,s):(s=[],h(o,i,n,s),t.push(s))}return t}var m=i(7716),v=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function l(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((n=n.apply(e,t||[])).next())}))};const g=o()("plugins/bash-like/pty/client"),y=/\x1b\[\?1h/,w=/\x1b\[\?1l/,b=/\x1b\[\??(47|1047|1049)h/,x=/\x1b\[\??(47|1047|1049)l/;let S,C=0;function k(e){const t=e._kui_pty_cachedSize;if(t&&t.resizeGeneration===C)return t}window&&window.addEventListener("resize",(()=>{C++}));class z{constructor(e,t,i,n){this.alt=!1,this.wasAlt=!1,this.app=!1,this._frozen=!1,this.tab=t,this.execOptions=i,this.terminal=e,this.uuid=n,this.resizeNow=this.resize.bind(this,!0),window.addEventListener("resize",this.resizeNow),this.clearXtermSelectionNow=()=>{e.clearSelection()},document.addEventListener("select",this.clearXtermSelectionNow),this.resize()}get ws(){return this._ws}set ws(e){this._ws=e}destroy(){this.exitAltBufferMode(),this.exitApplicationMode(),window.removeEventListener("resize",this.resizeNow),document.removeEventListener("select",this.clearXtermSelectionNow)}hideTrailingEmptyBlanks(e=!1,t=this.terminal.element,i=0){if(this.frozen)return;if(e)this.frozen=!0;else{const e=t.querySelectorAll(".xterm-rows > .xterm-hidden-row");for(let t=0;t<e.length;t++)e[t].classList.remove("xterm-hidden-row")}const n=t.querySelector(".xterm-rows").children;for(let t=n.length-1;t>=i&&0===n[t].children.length;t--)e?n[t].remove():n[t].classList.add("xterm-hidden-row")}static hideCursorOnlyRow(e){!function(e){const t=e.querySelector(".xterm-rows .xterm-cursor"),i=t&&t.parentNode;i&&1===i.children.length&&i.remove()}(e)}getSize(e){const t=k(this.tab);if(!e&&void 0!==t)return t;const i=this.terminal._core.viewport,n=i._renderService.dimensions,o=i._charSizeService.width*window.devicePixelRatio/n.scaledCharWidth,{width:s,height:r}=this.tab.getSize(),l=Math.floor(s/n.actualCellWidth/o),a=Math.floor(r/n.actualCellHeight);g("getSize",l,a,s,r);const c={rows:a,cols:l};return isNaN(a)||isNaN(l)||function(e,{rows:t,cols:i}){e._kui_pty_cachedSize={rows:t,cols:i,resizeGeneration:C}}(this.tab,c),c}set frozen(e){this._frozen=e}get frozen(){return this._frozen}resize(e=!1,t=!1){if(this.frozen)return;const{rows:i,cols:n}=this.getSize(e);if(this.terminal.rows!==i||this.terminal.cols!==n||t){g("resize",n,i,this.terminal.cols,this.terminal.rows,this.inAltBufferMode());try{isNaN(i)||isNaN(n)||(this.terminal.resize(n,i),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"resize",cols:n,rows:i,uuid:this.uuid})))}catch(e){g(e.message)}}}inApplicationMode(){return this.app}inAltBufferMode(){return this.alt}wasEverInAltBufferMode(){return this.wasAlt}enterApplicationMode(){g("switching to application mode"),this.app=!0,this.tab.addClass("xterm-application-mode")}exitApplicationMode(){g("switching from application mode"),this.app=!1,this.tab.removeClass("xterm-application-mode")}enterAltBufferMode(){if(g("switching to alt buffer mode"),this.alt=!0,this.wasAlt=!0,this.exitAlt&&clearTimeout(this.exitAlt),this.execOptions["pty/force-resize"]){const{rows:e,cols:t}=this.getSize(!1);this.ws&&this.ws.readyState===WebSocket.OPEN&&(this.ws.send(JSON.stringify({type:"resize",cols:t,rows:e+1,uuid:this.uuid})),setTimeout((()=>{this.ws.send(JSON.stringify({type:"resize",cols:t,rows:e,uuid:this.uuid})),this.tab.addClass("xterm-alt-buffer-mode")}),1))}else this.tab.addClass("xterm-alt-buffer-mode")}exitAltBufferMode(){g("switching from alt buffer mode"),this.alt=!1,this.tab.removeClass("xterm-alt-buffer-mode")}}function N(e){if(e||!S){g("computing font properties");const e=getComputedStyle(document.querySelector("body .repl .repl-input .repl-input-element")),t=(t,i="color")=>e.getPropertyValue(`--${i}-${t}`).trim(),i=parseFloat(e.fontSize.replace(/px$/,"")),n=t("monospace","font");S={fontFamily:n,fontSize:i}}return S}const E=(e,t=!1)=>{try{const{fontFamily:i,fontSize:n}=N(t);e.setOption("fontFamily",i),e.setOption("fontSize",n),g("fontSize",n),e.setOption("fontWeight",400),e.setOption("fontWeightBold",600)}catch(e){console.error("Error setting terminal font size",e)}},A=e=>v(void 0,void 0,void 0,(function*(){try{const t=yield e.REPL.rexec("bash websocket open",{rethrowErrors:!0}),{proto:n,port:o,path:s,uid:r,gid:l}=t.content,a=window.location.href.replace(/#?\/?$/,"").replace(/^http(s?):\/\/([^:/]+)(:\d+)?/,`${n}://$2${-1===o?"$3":":"+o}`).replace(/\/(index\.html)?$/,""),c=new URL(s,a).href;g("websocket url",c,n,o,s,r,l);return new(0,(yield i.e(7011).then(i.bind(i,67011))).default)(c,r,l)}catch(e){throw 503!==e.statusCode&&console.error("error opening websocket",e),e}})),O=()=>v(void 0,void 0,void 0,(function*(){const e=new c.IJ;return e.init(),e})),B=()=>v(void 0,void 0,void 0,(function*(){console.log("webviewChannelFactory");const e=new c.hV;return e.init(),e})),L=(e,t,i,n,o)=>new Promise(((i,n)=>{v(void 0,void 0,void 0,(function*(){let c,d,u,f;const h=(0,s.Z)();try{if((o.quiet||o.replSilence)&&g("Warning: non-headless PTY exec without a head"),!o.quiet&&!o.replSilence){u=document.createElement("xterm"),u.classList.add("xterm-container"),yield o.stdout(u),o.replSilence&&(g("repl silence"),u.style.display="none",u.classList.add("repl-temporary"));const t=k(e),{fontFamily:i,fontSize:n}=N(!1);d=new r.Terminal({rendererType:"dom",cols:t&&t.cols||80,rows:t&&t.rows||40,fontFamily:i,fontSize:n}),d.open(u);const s=()=>E(d,!0);l.eventChannelUnsafe.on("/theme/change",s),c=new z(d,e,o,h);const a=()=>{E(d,!0),c.resize()};l.eventChannelUnsafe.on("/zoom",a);const p=()=>{l.eventChannelUnsafe.off("/zoom",a),l.eventChannelUnsafe.off("/theme/change",s)};d.element.classList.add("xterm-empty-row-heuristic"),f=()=>{p(),c.destroy(),o.type===l.ExecType.Nested&&!1!==o.quiet||c.wasEverInAltBufferMode()?o.stdout(null):u.classList.add("xterm-terminated")}}const s=s=>v(void 0,void 0,void 0,(function*(){const r={write:e=>s.send(JSON.stringify({type:"data",data:e,uuid:h})),xon:()=>{g("xon requested"),s.send(JSON.stringify({type:"xon",uuid:h}))},xoff:()=>{g("xoff requested"),s.send(JSON.stringify({type:"xoff",uuid:h}))},abort:()=>{g("abort requested"),s.send(JSON.stringify({type:"kill",uuid:h}))}};yield function(e,t,i,n,o,s,r,a,c,d,u,f,h){return v(this,void 0,void 0,(function*(){let a,m=!1,S=0;const C=e=>{e._kuiAlreadyFocused||setTimeout((()=>{m||e._kuiAlreadyFocused||(e._kuiAlreadyFocused=!0,e.focus())}),100)};let k,z,N,E=!1,A="";e&&e.onData((e=>{m?n.frozen=!0:o.readyState===WebSocket.CLOSING||o.readyState===WebSocket.CLOSED?(g("queued input out back",e),A+=e):(A+=e,N&&(clearTimeout(N),N=void 0),N=setTimeout((()=>{if(A&&o.readyState===WebSocket.OPEN){const e=A;A="",o.send(JSON.stringify({type:"data",data:e,uuid:i}))}}),1))}));const O=()=>{n.inAltBufferMode()||s.scrollToBottom()},B=e&&setInterval(O,200),L=()=>{const t=(0,l.disableInputQueueing)(s);t.length>0&&(g("queued input up front",t),setTimeout((()=>o.send(JSON.stringify({type:"data",data:t,uuid:i}))),50)),e&&C(e)};let _;e&&(_=t=>{t&&setTimeout((()=>e.focus()))},s.onActivate(_));let T=!0;const M=e=>v(this,void 0,void 0,(function*(){(e.end>e.start||T)&&n.hideTrailingEmptyBlanks(),T=!1}));e&&(n.hideTrailingEmptyBlanks(),a=e.onRender(M));const I=N=>v(this,void 0,void 0,(function*(){const A=JSON.parse("string"==typeof N?N:N.data);if(A.uuid===i)if("state"===A.type&&"ready"===A.state)e&&L(),c.onReady&&(yield c.onReady(h));else if("data"===A.type&&e)e._kuiAlreadyFocused||L(),y.test(A.data)?(n.enterApplicationMode(),C(e)):w.test(A.data)&&n.exitApplicationMode(),b.test(A.data)?(C(e),n.enterAltBufferMode()):x.test(A.data)&&n.exitAltBufferMode(),c.type===l.ExecType.Nested&&!1!==c.quiet||(S++,E=!0,z=/File exists/i.test(A.data)?409:/no such/i.test(A.data)||/not found/i.test(A.data)?404:z,setTimeout((()=>{e.write(A.data,(()=>{--S<=0&&k&&k()}))})));else if("data"===A.type&&c.stdout&&c.onInit)E=!0,c.stdout(A.data);else if("exit"===A.type){g("exit",A.exitCode,r),m=!0,c.onExit&&c.onExit(A.exitCode),e&&(clearInterval(B),a.dispose(),s.offActivate(_)),0!==A.exitCode&&E&&void 0!==t&&t.classList.add("error");const i=e=>v(this,void 0,void 0,(function*(){if(0!==A.exitCode&&(E||c.onInit)){const t=new Error("");409===z?t.code=409:127!==A.exitCode&&404===z?t.code=404:t.code=A.exitCode,t.hide=!0,e?u(Object.assign(e,{code:t.code})):f(t)}else u(e||!0)}));if(!e)return o.removeEventListener("message",I),void i();const n=()=>{O(),o.removeEventListener("message",I),d(),window.requestAnimationFrame((()=>{c.stdout(null),i({apiVersion:"kui-shell/v1",kind:"XtermResponse",rows:p(e),code:0})}))};S>0?k=n:n()}}));o.on("message",I)}))}(d,u,h,c,s,e,t,0,o,f,i,n,r),o.onInit&&(o.stdout=yield o.onInit(r))})),S=yield((e,t,i,n,o,s,r)=>v(void 0,void 0,void 0,(function*(){const c=(0,l.inBrowser)()?void 0!==window["webview-proxy"]?B:A:O,d=Object.assign({},m.env,n.env||{}),u=i=>v(void 0,void 0,void 0,(function*(){i.removeEventListener("open",u),yield s(i);const n={type:"exec",cmdline:e,uuid:t,rows:o?o.rows:80,cols:o?o.cols:40,cwd:m.env.PWD||!(0,l.inBrowser)()&&m.cwd(),env:Object.keys(d).length>0&&d};g("exec after open",n),i.send(JSON.stringify(n))})),f=(0,a.getChannelForTab)(i);if(f&&f.readyState!==WebSocket.CLOSING&&f.readyState!==WebSocket.CLOSED)return u(f),o&&r(o),f;{const e=yield c(i);i.ws=e,e.on("open",(()=>u(e)));const n=function(o){g("channel has closed",o.target,t),e.removeEventListener("close",n),i.state.closed||(g("attempting to reestablish connection, because the tab is still open"),(0,a.invalidateSession)(i))};return e.on("close",n),e}})))(t,h,e,o,d,s,focus).catch((e=>{throw 503!==e.code&&console.error("error creating channel",e),f&&f(),e}));c&&(c.ws=S)}catch(e){const t=e;127===t.code||404===t.code?(t.code=127,n(t)):(503!==t.code&&g("error in pty/client",t),t.message||(t.message="Internal Error"),n(t))}}))}))},36065:(e,t,i)=>{"use strict";i.r(t),i.d(t,{getChannelForTab:()=>u,getSessionForTab:()=>f,init:()=>g,invalidateSession:()=>v,pollUntilOnline:()=>h});var n=i(11227),o=i.n(n),s=i(51173),r=i(95233);const l=o()("plugins/bash-like/pty/ui");var a=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function l(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((n=n.apply(e,t||[])).next())}))};const c=(0,s.i18n)("plugin-bash-like"),d=o()("plugins/bash-like/pty/session");function u(e){return e.ws}function f(e){return a(this,void 0,void 0,(function*(){if(void 0===e._kui_session&&(0,s.inElectron)()){const t=new r.IJ;return yield t.init(),e._kui_session=Promise.resolve(t),e._kui_session}return e._kui_session}))}function h(e){return new Promise((t=>{let i=!1;const n=setTimeout((()=>{i||(l("setOffline"),s.eventChannelUnsafe.emit("/proxy/offline"))}),5e3),o=(r=0)=>(d("trying to establish session",e),e.REPL.qexec("echo initializing session",void 0,void 0,{tab:e}).then((()=>{i=!0,clearTimeout(n),l("setOnline"),s.eventChannelUnsafe.emit("/proxy/online"),t()})).catch((e=>{const t=e;return 503!==t.code&&console.error("error establishing session",t.code,t.statusCode,t),setTimeout((()=>o(r+1)),r<10?2e3:r<100?4e3:1e4),c("Could not establish a new session")})));o()}))}let p;function m(e){return a(this,void 0,void 0,(function*(){const t=p||new Promise(((t,i)=>a(this,void 0,void 0,(function*(){try{yield h(e),e.classList.add("kui--session-init-done"),t(u(e))}catch(e){i(e)}}))));p||(p=t),e._kui_session=t,yield t,e.classList.add("kui--session-init-done")}))}function v(e){p=void 0,s.eventBus.emit("/tab/offline",e),s.eventBus.emitWithTabId("/tab/offline",e.state.uuid)}function g(e){return a(this,void 0,void 0,(function*(){const{proxyServer:t}=yield i.e(9599).then(i.t.bind(i,69599,19)).catch((()=>(console.log("using default proxy configuration"),{proxyServer:{enabled:!1}})));if((0,s.inBrowser)()&&!1!==t.enabled){d("initializing pty sessions");const{eventBus:t}=yield Promise.resolve().then(i.bind(i,51173));e.registerSessionInitializer(m),t.on("/tab/close",(e=>a(this,void 0,void 0,(function*(){try{d("closing session for tab");const t=u(e);t&&t.close()}catch(e){console.error("error terminating session for closed tab",e)}}))))}}))}},32383:()=>{}}]);